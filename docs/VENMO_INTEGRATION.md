# Venmo Email Integration

Automatically track Venmo payments by parsing email notifications.

## Architecture

```
Gmail (venmo@venmo.com) 
    ↓ filter + forward
Cloudflare Email Worker (parse MIME → JSON)
    ↓ POST with secret
Supabase Edge Function (/parse-venmo)
    ↓ regex extraction
venmo_transactions table
    ↓ auto-match
payments table (status → paid)
```

## How It Works

1. **Gmail Filter**: Forwards Venmo emails to Cloudflare
2. **Cloudflare Worker**: Parses raw email into JSON
3. **Supabase Function**: Extracts transaction data (amount, sender, note)
4. **Auto-Matching**: 
   - By hashtag: `#dinkup-{payment_id}` in Venmo note
   - By amount + name: Fuzzy matches pending payments

## Setup

### 1. Deploy Supabase Edge Function

```bash
# Deploy the function
supabase functions deploy parse-venmo

# Set the secret
supabase secrets set VENMO_WEBHOOK_SECRET=your-secret-here
```

### 2. Configure Cloudflare Email Worker

1. Go to Cloudflare Dashboard → Email Routing → Email Workers
2. Create a new worker, paste the code from `docs/cloudflare-venmo-worker.js`
3. Add environment variables:
   - `SUPABASE_FUNCTION_URL`: `https://your-project.supabase.co/functions/v1/parse-venmo`
   - `VENMO_WEBHOOK_SECRET`: Same secret as Supabase

### 3. Set Up Email Route

1. In Cloudflare Email Routing, create a route:
   - Custom address: `venmo@yourdomain.com` (or any address)
   - Action: Send to Worker → select your worker

### 4. Configure Gmail Forwarding

1. In Gmail Settings → Filters, create a filter:
   - From: `venmo@venmo.com`
   - Action: Forward to `venmo@yourdomain.com`
2. Gmail will send a verification email
3. Check Cloudflare Worker logs for the verification link/code
4. Complete verification in Gmail

## Hashtag Format

For automatic matching, include a hashtag in your Venmo payment note:

```
#dinkup-{payment_id}
```

Example: `Pickleball session #dinkup-abc123-def456`

The Venmo link generated by the app already includes this hashtag.

## Database Schema

```sql
CREATE TABLE venmo_transactions (
  id uuid PRIMARY KEY,
  created_at timestamptz,
  transaction_type venmo_transaction_type, -- payment_sent, payment_received, etc.
  amount numeric(10, 2),
  sender_name text,
  recipient_name text,
  note text,
  hashtag text,
  payment_id uuid REFERENCES payments(id), -- Matched payment
  matched_at timestamptz,
  match_method text, -- auto_hashtag, auto_amount, manual
  raw_json jsonb,
  processed boolean
);
```

## Environment Variables

| Variable | Location | Description |
|----------|----------|-------------|
| `VENMO_WEBHOOK_SECRET` | Supabase + Cloudflare | Shared secret for auth |
| `SUPABASE_FUNCTION_URL` | Cloudflare | Edge function URL |

## Testing

### Test Venmo Account
For development/testing, use `@Leah-Berkman` as a test Venmo recipient.

### Test Edge Function Directly

```bash
curl -X POST https://your-project.supabase.co/functions/v1/parse-venmo \
  -H "Content-Type: application/json" \
  -H "X-Venmo-Webhook-Secret: your-secret" \
  -d '{
    "from": "venmo@venmo.com",
    "subject": "John Doe paid you $16.00",
    "text": "Payment for pickleball #dinkup-abc123",
    "date": "2026-01-09T10:00:00Z"
  }'
```

## Matching Logic

### Priority 1: Hashtag Match
If the Venmo note contains `#dinkup-{payment_id}` or `#pay-{payment_id}`, we:
1. Look up the payment by ID
2. Verify the amount matches
3. Auto-mark as paid

### Priority 2: Amount + Name Match
For received payments without hashtags:
1. Find pending payments with matching amount
2. Fuzzy match sender name to player names
3. Link the transaction but **don't auto-mark** (needs manual review)

## Limitations

- Only processes emails that match Venmo's standard format
- Hashtag matching requires exact payment ID
- Name matching is fuzzy and may need manual review
- Doesn't handle refunds or declined payments yet
